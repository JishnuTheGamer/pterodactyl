#!/bin/bash

# ANSI color codes
BLUE='\033[0;34m'
BOLD_BLUE='\033[1;34m'
LIGHT_BLUE='\033[0;94m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Print a fancy header
echo -e "${BOLD_BLUE}"
echo "

                                                     
    _/_/_/      _/                                   
   _/    _/  _/_/_/_/    _/_/    _/  _/_/    _/_/    
  _/_/_/      _/      _/_/_/_/  _/_/      _/    _/   
 _/          _/      _/        _/        _/    _/    
_/            _/_/    _/_/_/  _/          _/_/       
                                                     
                                                     
"
echo -e "${NC}"
echo "This only install panel"

apt -y install software-properties-common curl apt-transport-https ca-certificates gnupg

# Add additional repositories for PHP (Ubuntu 20.04 and Ubuntu 22.04)
LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php

# Add Redis official APT repository
curl -fsSL https://packages.redis.io/gpg | sudo gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/redis.list

# MariaDB repo setup script (Ubuntu 20.04)
curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | sudo bash

# Update repositories list
apt update

# Install Dependencies
apt -y install php8.3 php8.3-{common,cli,gd,mysql,mbstring,bcmath,xml,fpm,curl,zip} mariadb-server nginx tar unzip git redis-server


apt update

apt -y install php8.3 php8.3-{common,cli,gd,mysql,mbstring,bcmath,xml,fpm,curl,zip} mariadb-server nginx tar unzip git redis-server

curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer

mkdir panel
cd panel

curl -Lo panel.tar.gz https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz
tar -xzvf panel.tar.gz
chmod -R 755 storage/* bootstrap/cache/

echo -e "${BLUE} starting mariadbd ${NC}"

sudo ls -la /var/run/mysqld/
   
   # Remove the stale socket if it exists
   sudo rm /var/run/mysqld/mysqld.sock

sudo mkdir -p /var/run/mysqld
   sudo chown mysql:mysql /var/run/mysqld
   sudo chmod 755 /var/run/mysqld

sudo ps aux | grep mysql
   sudo ps aux | grep maria
   
   # Kill any existing processes if needed
   sudo pkill mysqld
   sudo pkill mariadbd

nohup sudo mariadbd --socket=/var/run/mysqld/mysqld.sock --user=root > /dev/null 2>&1 &


# Config
DB_USER="pterodactyl"
DB_PASS="yourPassword"
DB_NAME="panel"
DB_HOST="127.0.0.1"
ROOT_PASS="root"

# Execute SQL
mysql -u root -p"${ROOT_PASS}" <<EOF
CREATE USER '${DB_USER}'@'${DB_HOST}' IDENTIFIED BY '${DB_PASS}';
CREATE DATABASE ${DB_NAME};
GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'${DB_HOST}' WITH GRANT OPTION;
FLUSH PRIVILEGES;
EOF

echo "Database and user created successfully."

cp .env.example .env
COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader

php artisan key:generate --force

php artisan p:environment:setup
php artisan p:environment:database

php artisan migrate --seed --force

php artisan p:user:make

echo "Starting"
echo "using php -S localhost:8000 in folder 📁 public "

cd public
php -S localhost:8000
